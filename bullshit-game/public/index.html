<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bullshit Card Game - Online Multiplayer</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .screen {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .hidden {
            display: none;
        }

        input, select {
            padding: 12px;
            margin: 5px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            width: 100%;
            max-width: 300px;
        }

        button {
            padding: 12px 30px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover:not(:disabled) {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover:not(:disabled) {
            background: #d32f2f;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover:not(:disabled) {
            background: #1976D2;
        }

        .room-code {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .room-code h2 {
            font-size: 36px;
            letter-spacing: 5px;
            color: #ffeb3b;
        }

        .players-waiting {
            margin: 20px 0;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .info-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .info-card p {
            font-size: 20px;
            font-weight: bold;
        }

        .table-area {
            background: radial-gradient(circle, rgba(34, 139, 34, 0.4) 0%, rgba(0, 100, 0, 0.5) 100%);
            border: 5px solid #2d5016;
            border-radius: 50%;
            padding: 40px;
            margin: 30px auto;
            width: 400px;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4), inset 0 0 50px rgba(0,0,0,0.2);
            position: relative;
        }

        @media (max-width: 768px) {
            .table-area {
                width: 300px;
                height: 300px;
                padding: 20px;
            }
        }

        .card-pile {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 20px auto;
        }

        .pile-card {
            position: absolute;
            width: 100px;
            height: 140px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s;
        }

        .pile-card:nth-child(1) { transform: rotate(-5deg) translate(-2px, -2px); z-index: 1; }
        .pile-card:nth-child(2) { transform: rotate(2deg) translate(1px, 1px); z-index: 2; }
        .pile-card:nth-child(3) { transform: rotate(-3deg) translate(-1px, 2px); z-index: 3; }
        .pile-card:nth-child(4) { transform: rotate(4deg) translate(2px, -1px); z-index: 4; }
        .pile-card:nth-child(5) { transform: rotate(0deg); z-index: 5; }

        .pile-card-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 48px;
        }

        .pile-empty {
            width: 100px;
            height: 140px;
            border: 3px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
        }

        .player-hand {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .card {
            width: 80px;
            height: 110px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            color: black;
            font-weight: bold;
            font-size: 18px;
        }

        .card.red {
            color: #d32f2f;
        }

        .card.selected {
            border-color: #ffeb3b;
            transform: translateY(-10px);
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .card .value {
            font-size: 24px;
        }

        .card .suit {
            font-size: 28px;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .player-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .player-status.current {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .message {
            background: rgba(255, 235, 59, 0.2);
            border: 2px solid #ffeb3b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 18px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .claim-input {
            margin: 20px 0;
            text-align: center;
            background: rgba(255, 235, 59, 0.15);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffeb3b;
        }

        .claim-input label {
            font-weight: bold;
            font-size: 18px;
            margin-right: 10px;
        }

        #claimValue {
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            background: white;
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Reveal Cards Modal */
        .reveal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .reveal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .reveal-content h2 {
            color: white;
            text-align: center;
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .reveal-content p {
            color: #ffeb3b;
            text-align: center;
            font-size: 20px;
            margin-bottom: 30px;
        }

        .revealed-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .revealed-card {
            width: 120px;
            height: 160px;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            animation: cardFlip 0.5s;
            position: relative;
        }

        @keyframes cardFlip {
            0% { transform: rotateY(90deg); }
            100% { transform: rotateY(0); }
        }

        .revealed-card.red {
            color: #d32f2f;
        }

        .revealed-card .value {
            font-size: 36px;
            font-weight: bold;
        }

        .revealed-card .suit {
            font-size: 48px;
        }

        .reveal-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            color: white;
            text-align: center;
        }

        .reveal-close {
            background: #4CAF50;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
            transition: background 0.3s;
        }

        .reveal-close:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ô†Ô∏è Bullshit Card Game ‚ô•Ô∏è</h1>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <h2>Welcome!</h2>
            <div style="margin: 20px 0;">
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
            </div>
            <div>
                <button onclick="createRoom()">Create Room</button>
                <button onclick="showJoinRoom()" class="secondary">Join Room</button>
            </div>
            <div id="joinRoomDiv" class="hidden" style="margin-top: 20px;">
                <input type="text" id="roomCodeInput" placeholder="Enter room code" maxlength="6" style="text-transform: uppercase;">
                <button onclick="joinRoom()">Join</button>
            </div>
        </div>

        <!-- Waiting Room -->
        <div id="waitingScreen" class="screen hidden">
            <div class="room-code">
                <p>Room Code:</p>
                <h2 id="displayRoomCode">------</h2>
                <p style="font-size: 14px; margin-top: 10px;">Share this code with your friends!</p>
            </div>
            
            <div class="players-waiting">
                <h3>Players in Room:</h3>
                <div id="playersWaiting"></div>
            </div>
            
            <div id="hostControls" class="hidden">
                <button onclick="startGame()">Start Game</button>
            </div>
            
            <div id="messageArea"></div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen hidden">
            <div class="game-info">
                <div class="info-card">
                    <h3>Current Player</h3>
                    <p id="currentPlayerName">-</p>
                </div>
                <div class="info-card">
                    <h3>Cards in Pile</h3>
                    <p id="pileCount">0</p>
                </div>
                <div class="info-card">
                    <h3>Current Minimum</h3>
                    <p id="currentMin">-</p>
                </div>
                <div class="info-card">
                    <h3>Deck Remaining</h3>
                    <p id="deckCount">0</p>
                </div>
            </div>

            <div class="players-list" id="playersList"></div>

            <div id="gameMessageArea"></div>

            <div class="table-area">
                <h3 style="margin-bottom: 10px;">üÉè Table Pile üÉè</h3>
                <div id="cardPile" class="card-pile">
                    <div class="pile-empty">Empty</div>
                </div>
                <p id="lastPlayed" style="color: #ffeb3b; font-size: 16px; margin: 10px 0;">Waiting for first play...</p>
                <p style="font-size: 14px; opacity: 0.8;">Cards in pile: <span id="pileCountTable">0</span></p>
                <button id="checkBtn" class="danger" onclick="checkPlayer()" disabled>
                    ‚ö†Ô∏è Check Previous Player!
                </button>
            </div>

            <div id="claimArea" class="claim-input hidden">
                <label>I claim to play: </label>
                <select id="claimValue">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">Jack</option>
                    <option value="12">Queen</option>
                    <option value="13">King</option>
                    <option value="14">Ace</option>
                </select>
            </div>

            <div class="player-hand">
                <h3>Your Hand (<span id="handCount">0</span> cards)</h3>
                <div id="playerHand" class="cards"></div>
            </div>

            <div class="controls">
                <button id="playBtn" onclick="playCards()" disabled>
                    Play Selected Cards
                </button>
                <button onclick="deselectAll()" class="secondary">Deselect All</button>
            </div>
        </div>
    </div>

    <!-- Reveal Cards Modal -->
    <div id="revealModal" class="reveal-modal hidden" onclick="handleModalClick(event)">
        <div class="reveal-content" onclick="event.stopPropagation()">
            <h2 id="revealTitle">Cards Revealed!</h2>
            <p id="revealSubtitle"></p>
            <div class="revealed-cards" id="revealedCards"></div>
            <div class="reveal-info" id="revealInfo"></div>
            <button class="reveal-close" onclick="closeRevealModal()">Continue Game</button>
        </div>
    </div>

    <script>
        const socket = io();
        let roomCode = '';
        let myHand = [];
        let selectedCards = [];
        let gameState = null;
        let isHost = false;
        let lastRevealedCheckId = null; // Track last revealed check to prevent duplicates

        // Lobby functions
        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name!');
                return;
            }
            
            socket.emit('createRoom', { playerName });
            isHost = true;
        }

        function showJoinRoom() {
            document.getElementById('joinRoomDiv').classList.remove('hidden');
        }

        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!playerName || !code) {
                alert('Please enter your name and room code!');
                return;
            }
            
            socket.emit('joinRoom', { playerName, roomCode: code });
            roomCode = code;
        }

        function startGame() {
            socket.emit('startGame', { roomCode });
        }

        function playCards() {
            if (selectedCards.length === 0) return;
            
            const claimedValue = parseInt(document.getElementById('claimValue').value);
            socket.emit('playCards', { 
                roomCode, 
                cards: selectedCards,
                claimedValue 
            });
            
            selectedCards = [];
        }

        function checkPlayer() {
            socket.emit('checkPlayer', { roomCode });
        }

        function deselectAll() {
            selectedCards = [];
            renderHand();
        }

        function toggleCard(index) {
            const idx = selectedCards.indexOf(index);
            if (idx > -1) {
                selectedCards.splice(idx, 1);
            } else {
                selectedCards.push(index);
            }
            renderHand();
            updateUI();
        }

        function renderHand() {
            const handDiv = document.getElementById('playerHand');
            handDiv.innerHTML = '';
            document.getElementById('handCount').textContent = myHand.length;

            myHand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card' + (card.isRed ? ' red' : '');
                if (selectedCards.includes(index)) {
                    cardDiv.classList.add('selected');
                }
                
                if (card.isJoker) {
                    cardDiv.innerHTML = `
                        <div class="suit">üÉè</div>
                        <div style="font-size: 10px; margin-top: 2px;">WILD</div>
                    `;
                } else {
                    cardDiv.innerHTML = `
                        <div class="value">${card.value}</div>
                        <div class="suit">${card.suit}</div>
                    `;
                }
                
                cardDiv.onclick = () => toggleCard(index);
                handDiv.appendChild(cardDiv);
            });
        }

        function updateUI() {
            if (!gameState) return;
            
            const isMyTurn = gameState.players[gameState.currentPlayerIndex]?.id === socket.id;
            const validCount = [1, 3, 4, 5, 6].includes(selectedCards.length);
            
            document.getElementById('playBtn').disabled = !isMyTurn || selectedCards.length === 0 || !validCount;
            document.getElementById('checkBtn').disabled = gameState.pileCount === 0 || !gameState.canCheck;
            document.getElementById('claimArea').classList.toggle('hidden', selectedCards.length === 0 || !isMyTurn);
            
            document.getElementById('currentPlayerName').textContent = gameState.players[gameState.currentPlayerIndex]?.name || '-';
            document.getElementById('pileCount').textContent = gameState.pileCount;
            document.getElementById('pileCountTable').textContent = gameState.pileCount;
            document.getElementById('currentMin').textContent = getValueName(gameState.currentMin);
            document.getElementById('deckCount').textContent = gameState.deckCount;
            
            // Update visual pile
            updateVisualPile(gameState.pileCount);
            
            // Update players list
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            gameState.players.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = 'player-status' + (index === gameState.currentPlayerIndex ? ' current' : '');
                div.innerHTML = `<strong>${player.name}</strong><br>${player.cardCount} cards`;
                playersList.appendChild(div);
            });
        }

        function updateVisualPile(count) {
            const pileDiv = document.getElementById('cardPile');
            pileDiv.innerHTML = '';
            
            if (count === 0) {
                pileDiv.innerHTML = '<div class="pile-empty">Empty</div>';
            } else {
                const cardsToShow = Math.min(count, 5);
                for (let i = 0; i < cardsToShow; i++) {
                    const card = document.createElement('div');
                    card.className = 'pile-card pile-card-back';
                    card.innerHTML = 'üÇ†';
                    pileDiv.appendChild(card);
                }
            }
        }

        function getValueName(num) {
            const names = {2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9', 10: '10', 11: 'Jack', 12: 'Queen', 13: 'King', 14: 'Ace'};
            return names[num] || num;
        }

        function showMessage(msg, area = 'messageArea') {
            const msgDiv = document.getElementById(area);
            msgDiv.innerHTML = `<div class="message">${msg}</div>`;
            setTimeout(() => {
                msgDiv.innerHTML = '';
            }, 5000);
        }

        // Socket event listeners
        socket.on('roomCreated', (data) => {
            roomCode = data.roomCode;
            document.getElementById('displayRoomCode').textContent = roomCode;
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('waitingScreen').classList.remove('hidden');
            document.getElementById('hostControls').classList.remove('hidden');
            
            updateWaitingPlayers(data.players);
        });

        socket.on('playerJoined', (data) => {
            updateWaitingPlayers(data.players);
            showMessage(`Player joined the room!`);
        });

        socket.on('playerLeft', (data) => {
            showMessage(`${data.playerName} left the room`);
            updateWaitingPlayers(data.players);
        });

        socket.on('gameStarted', (data) => {
            myHand = data.yourHand;
            gameState = data;
            gameState.canCheck = false;
            
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            renderHand();
            updateUI();
            showMessage(`Game started! ${data.players[data.currentPlayerIndex].name} goes first!`, 'gameMessageArea');
        });

        socket.on('gameUpdate', (data) => {
            myHand = data.yourHand;
            gameState = data;
            gameState.canCheck = data.canCheck !== false;
            
            renderHand();
            updateUI();
            
            if (data.lastPlay) {
                document.getElementById('lastPlayed').textContent = 
                    `${data.lastPlay.playerName} claimed ${getValueName(data.lastPlay.claimedValue)} (${data.lastPlay.cardCount} cards)`;
                showMessage(`${data.lastPlay.playerName} played ${data.lastPlay.cardCount} card(s) claiming ${getValueName(data.lastPlay.claimedValue)}`, 'gameMessageArea');
            }
            
            // Show reveal modal if cards were checked (only once per check)
            if (data.revealedCards && data.revealedCards.length > 0 && data.checkId && data.checkId !== lastRevealedCheckId) {
                lastRevealedCheckId = data.checkId;
                showRevealModal(data);
            }
            
            if (data.message) {
                showMessage(data.message, 'gameMessageArea');
            }
            
            if (data.winner) {
                showMessage(`üéâ ${data.winner} wins! üéâ`, 'gameMessageArea');
                document.getElementById('playBtn').disabled = true;
                document.getElementById('checkBtn').disabled = true;
            }
        });

        socket.on('error', (data) => {
            alert(data.message);
        });

        function updateWaitingPlayers(players) {
            const div = document.getElementById('playersWaiting');
            div.innerHTML = '';
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.textContent = `${player.name} ${player.isHost ? '(Host)' : ''}`;
                div.appendChild(playerDiv);
            });
        }

        function showRevealModal(data) {
            const modal = document.getElementById('revealModal');
            const title = document.getElementById('revealTitle');
            const subtitle = document.getElementById('revealSubtitle');
            const cardsDiv = document.getElementById('revealedCards');
            const info = document.getElementById('revealInfo');
            
            // Set title based on result
            if (data.wasLying) {
                title.textContent = 'üö® CAUGHT LYING! üö®';
                title.style.color = '#ff5252';
                subtitle.textContent = `${data.checkedPlayer} played these cards:`;
            } else {
                title.textContent = '‚úÖ TELLING THE TRUTH! ‚úÖ';
                title.style.color = '#4CAF50';
                subtitle.textContent = `${data.checkedPlayer} played these cards:`;
            }
            
            // Display revealed cards
            cardsDiv.innerHTML = '';
            data.revealedCards.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'revealed-card' + (card.isRed ? ' red' : '');
                cardDiv.style.animationDelay = `${index * 0.1}s`;
                
                if (card.isJoker) {
                    cardDiv.innerHTML = `
                        <div class="suit">üÉè</div>
                        <div style="font-size: 12px; margin-top: 5px; font-weight: bold;">JOKER</div>
                        <div style="font-size: 11px; color: #666;">(Wildcard)</div>
                    `;
                } else {
                    cardDiv.innerHTML = `
                        <div class="value">${card.value}</div>
                        <div class="suit">${card.suit}</div>
                    `;
                }
                cardsDiv.appendChild(cardDiv);
            });
            
            // Set info message
            const hasJoker = data.revealedCards.some(c => c.isJoker);
            if (data.wasLying) {
                info.innerHTML = `
                    <strong>${data.checkedPlayer}</strong> was caught lying!<br>
                    They receive <strong>${data.revealedCards.length} checked cards + ${data.additionalCardCount} penalty cards</strong><br>
                    and <strong>lose their turn!</strong>
                `;
            } else {
                info.innerHTML = `
                    <strong>${data.checkerPlayer}</strong> was wrong to check!<br>
                    ${hasJoker ? '<em>Note: Jokers are wildcards and count as any value!</em><br>' : ''}
                    They receive <strong>${data.revealedCards.length} checked cards + ${data.additionalCardCount} penalty cards</strong><br>
                    and <strong>lose their turn!</strong>
                `;
            }
            
            modal.classList.remove('hidden');
        }

        function closeRevealModal() {
            const modal = document.getElementById('revealModal');
            modal.classList.add('hidden');
            // Clear the revealed cards to prevent re-showing
            if (gameState) {
                delete gameState.revealedCards;
            }
        }

        function handleModalClick(event) {
            // Close modal if clicking on the dark overlay (not the content)
            if (event.target.id === 'revealModal') {
                closeRevealModal();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('revealModal');
                if (!modal.classList.contains('hidden')) {
                    closeRevealModal();
                }
            }
        });
    </script>
</body>
</html>
